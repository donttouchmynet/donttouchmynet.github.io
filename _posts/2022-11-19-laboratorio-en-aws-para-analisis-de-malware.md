---
title: "Laboratorio en AWS para análisis de malware"
author: Adan Alvarez
classes: wide
excerpt: "En esta entrada vamos a ver como crear nuestro propio laboratorio en AWS para analizar malware utilizando FlareVM, Apache Guacamole y Terraform."
categories:
  - AWS
tags:
  - Malware
  - Blue Team
  - Lab
  - Terraform
---
Después de finalizar el curso [Practical Malware Analysis & Triage (PMAT)](https://academy.tcm-sec.com/p/practical-malware-analysis-triage), el cual recomiendo, me di cuenta de que necesitaba un laboratorio que pudiera crear y destruir según necesitara. Por esto decidí automatizar la creación y destrucción del laboratorio mediante Terraform.{: style="text-align: justify;"}

En esta entrada vamos a ver como crear nuestro propio laboratorio en AWS para analizar malware utilizando [FlareVM](https://github.com/mandiant/flare-vm), [Apache Guacamole](https://guacamole.apache.org/) y [Terraform](https://www.terraform.io/).{: style="text-align: justify;"}

Para poder crear el laboratorio es imprescindible tener una cuenta de AWS.{: style="text-align: justify;"}

Los pasos que vamos a seguir para configurar el laboratorio son los siguientes:
 - Crear, de forma manual, una instancia Windows en AWS.
 - Configuraremos esta instancia con FlareVM.
 - Generaremos una AMI basada en esta instancia, esta será la imagen que usaremos para probar nuestro malware.
 - Eliminaremos la instancia y configuraremos Terraform.
 - Utilizaremos Terraform para crear, destruir el laboratorio y regenerar nuestra FlareVM tantas veces como necesitemos. 


 El laboratorio tendrá dos posibles configuraciones:{: style="text-align: justify;"}

**Configuración con Internet:** Se creará solo una instancia Windows con FlareVM que tendrá acceso a Internet y a la cual se podrá acceder por RDP también desde Internet. En esta configuración tendremos que tener en cuenta que las muestras de malware serán capaces de conectarse a Internet.{: style="text-align: justify;"}


**Configuración sin Internet:** Se crearán dos instancias, la instancia Windows con FlareVM que no tendrá acceso a Internet, y una instancia con Apache Guacamole que será accesible desde Internet. Para poder conectarnos a FlareVM utilizaremos Apache Guacamole. Para esta configuración será necesario que configuremos un servidor SFTP en la máquina FlareVM que nos permitirá subir las muestras de malware que queramos analizar.{: style="text-align: justify;"}

[![](https://donttouchmynet.github.io/assets/images/labConfigurations.PNG)](https://donttouchmynet.github.io/assets/images/labConfigurations.PNG)

 ## Creación de la imagen base de Windows con FlareVM
Al final de este apartado tendremos una imagen AMI personalizada y la contraseña de administrador de la máquina.{: style="text-align: justify;"}{: style="text-align: justify;"}

Primero, accedemos vía web a la consola de AWS, vamos a instancias y creamos una nueva instancia.{: style="text-align: justify;"}

Seleccionaremos una AMI de Windows, en mi caso seleccioné Microsoft Windows Server 2022 Base.{: style="text-align: justify;"}

[![](https://donttouchmynet.github.io/assets/images/windowsAMI.PNG)](https://donttouchmynet.github.io/assets/images/windowsAMI.PNG)

Seleccionamos el tipo de instancia, una instancia de tipo t2.medium debería ser suficiente, y escogemos una de nuestras claves. Si no tenemos ninguna clave generada [generamos una](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/create-key-pairs.html).{: style="text-align: justify;"}

En la configuración de red nos debemos asegurar que la instancia está en una VPC pública, que tiene habilitado el *auto-assign public IP* y que el grupo de seguridad permite el acceso mediante RDP.{: style="text-align: justify;"}

[![](https://donttouchmynet.github.io/assets/images/windowsNetwork.PNG)](https://donttouchmynet.github.io/assets/images/windowsNetwork.PNG)

Por último, en el apartado de configuración de almacenamiento, subimos la capacidad a 60 GB para no tener problemas de espacio en el futuro.{: style="text-align: justify;"}

Tras esto creamos la instancia.{: style="text-align: justify;"}

En el apartado instancias esperamos hasta que la instancia esté inicializada y una vez lista accederemos a ella. Hacemos clic en *Connect*, descargamos el fichero para conectarnos por RDP y obtenemos la contraseña. **Importante**, debemos guardar esta contraseña en un lugar seguro, ya que es la que utilizaremos para acceder a nuestra máquina Windows ahora y en el futuro. Una vez creemos la AMI no será posible obtener la contraseña mediante este procedimiento.{: style="text-align: justify;"}

Con el fichero de configuración y la contraseña accedemos a esta mediante RDP.{: style="text-align: justify;"}

Ahora deberemos instalar todas las herramientas que queramos tener en nuestro laboratorio, esta máquina es la que usaremos para detonar el malware.{: style="text-align: justify;"}

Instalaremos en primer lugar FlareVM

Descargamos el fichero de instalación: https://github.com/mandiant/flare-vm/blob/master/install.ps1

Abrimos una consola de PowerShell como Administrador

Desbloqueamos el instalador: ```Unblock-File .\install.ps1```

Habilitamos la ejecución de scripts: ```Set-ExecutionPolicy Unrestricted``` 

Ejecutamos el instalador (este nos pedirá la contraseña de adminsitrador): ```.\install.ps1```

[![](https://donttouchmynet.github.io/assets/images/InstallFlareVM.PNG)](https://donttouchmynet.github.io/assets/images/InstallFlareVM.PNG)

La instalación de FlareVM es lenta, este será el momento de ir a tomar un café.{: style="text-align: justify;"}

Si nuestro objetivo es tener FlareVM en una entorno sin acceso a Internet, será necesario instalar también un servidor SFTP que nos permita mover ficheros desde el Apache Guacamole a FlareVM. Una opción rápida es descargar [Rebex Tiny SFTP Server](https://www.rebex.net/tiny-sftp-server/).{: style="text-align: justify;"}

Además de esto, este es el momento para instalar cualquier otra herramienta que creamos necesaria.{: style="text-align: justify;"}

Una vez nos sintamos cómodos con la configuración, procederemos a crear la imagen base.{: style="text-align: justify;"}

Volvemos a la consola de AWS, instancias y apagamos nuestra instancia Windows recién configurada.{: style="text-align: justify;"}
Una vez apagada, seleccionamos la instancia de nuevo y en acciones vamos a *Image - Create Image*{: style="text-align: justify;"}

[![](https://donttouchmynet.github.io/assets/images/createImage.PNG)](https://donttouchmynet.github.io/assets/images/createImage.PNG)

Especificamos un nombre único para la imagen y si lo deseamos una descripción. Con esto hacemos clic en *Create Image*{: style="text-align: justify;"}

[*Aquí*](https://docs.aws.amazon.com/AWSEC2/latest/WindowsGuide/Creating_EBSbacked_WinAMI.html) *podremos encontrar más información sobre como crear la AMI desde nuestra instancia si tenemos problemas*.{: style="text-align: justify;"}


Vamos a AMIs y ahí veremos como nuestra imagen se está creando. Apuntamos el AMI ID que junto con la contraseña obtenida anteriormente serán los valores que necesitaremos para el próximo paso.{: style="text-align: justify;"}

Procedemos a borrar la instancia creada, lo único que necesitaremos en nuestra cuenta (y por lo que pagaremos) será la AMI generada.{: style="text-align: justify;"}



 ## Creación del laboratorio
Para poder crear en laboratorio necesitaremos:
  - El AMI ID y la contraseña de administrador de la máquina creada en el paso anterior.
  - [Claves de acceso a AWS](https://aws.amazon.com/es/premiumsupport/knowledge-center/create-access-key/) con permisos para gestionar la red y las instancias.
  - Una terminal con las [claves de AWS configuradas](https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-quickstart.html).
  - Tener instalado [Terraform](https://developer.hashicorp.com/terraform/tutorials/aws-get-started/install-cli), [jq](https://stedolan.github.io/jq/download/) y [git](https://git-scm.com/book/en/v2/Getting-Started-Installing-Git)
  - (Opcional) si queremos utilizar la opción sin Internet y con acceso mediante Apache Guacamole, aceptar la licencia de Apache Guacamole https://aws.amazon.com/marketplace/pp?sku=6sq2ud425j12tj4didc8xzf6m (El software no tiene precio, pero está empaquetado por Bitnami){: style="text-align: justify;"}

Una vez tenemos los requisitos clonamos el repositorio adanalvarez/AWS-malware-lab: {: style="text-align: justify;"}
``` 
git clone https://github.com/adanalvarez/AWS-malware-lab
cd AWS-malware-lab    
```
Creamos un fichero de configuración, con el nombre ```shared.auto.tfvars.json``` como el siguiente:{: style="text-align: justify;"}

```
{ 
    "environment": "malware-lab",
    "ami": "ami-xxxxxxxxxxxxxxxxx",
    "account" : "222222222222",
    "region": "eu-west-1",
    "enable_guacamole": false
}
```

Aquí introduciremos, el entorno, el AMI ID de la imagen creada en el paso anterior, [nuestra cuenta de AWS](https://docs.aws.amazon.com/IAM/latest/UserGuide/console_account-alias.html), la región donde desplegaremos el laboratorio y si queremos habilitar Apache Guacamole o no. {: style="text-align: justify;"}

Inicializamos Terraform y hacemos un plan para ver qué recursos se crearán:
```terraform init```
```terraform plan```

Tras esto realizaremos un apply para crear nuestro laboratorio.
```terraform apply```

Tras unos minutos nuestro laboratorio estará creado y listo para usarse.

 ## Acceder al entorno en con guacamole deshabilitado (Internet)

 Tras realizar el terraform apply nos aparecerá en la consola la IP pública de nuestra máquina FlareVM.{: style="text-align: justify;"}

 Podremos acceder directamente mediante RDP con la contraseña de Administrador que tenemos del primer apartado.{: style="text-align: justify;"}

 [![](https://donttouchmynet.github.io/assets/images/flareVMIP.PNG)](https://donttouchmynet.github.io/assets/images/flareVMIP.PNG)

 ## Acceder al entorno en con guacamole habilitado (no Internet)

 Tras realizar el terraform apply nos aparecerá en la consola la IP pública de Apache Guacamole, el usuario administrador y la contraseña generada.
 *Si el usuario y la contraseña generada aparecen en blanco, esperar unos minutos y realizar un terraform plan. Si tras varios minutos no aparece la contraseña, seguir el siguiente manual https://docs.bitnami.com/aws/faq/get-started/find-credentials/*{: style="text-align: justify;"}

 [![](https://donttouchmynet.github.io/assets/images/guacamoleVMIP.PNG)](https://donttouchmynet.github.io/assets/images/guacamoleVMIP.PNG)

 Mediante un navegador accedemos a la URL HTTPS://guacamole_public_ip e introducimos el usuario y contraseña que nos apareció en el output de Terraform.{: style="text-align: justify;"}

 Una vez en la interfaz de Apache Guacamole vamos a configurar una nueva conexión{: style="text-align: justify;"}

  [![](https://donttouchmynet.github.io/assets/images/guacamoleNewConnection.PNG)](https://donttouchmynet.github.io/assets/images/guacamoleNewConnection.PNG)

  Aquí configuraremos una conexión RDP con los datos de nuestra máquina FlareVM, la IP será 172.16.10.4 (aparecerá en el output de Terraform), el usuario será administrator y la contraseña será la que tenemos del primer apartado.{: style="text-align: justify;"}
  
  [![](https://donttouchmynet.github.io/assets/images/guacamoleConnectionConfiguration.PNG)](https://donttouchmynet.github.io/assets/images/guacamoleConnectionConfiguration.PNG)

  ### Configurar el servidor SFTP para transferir ficheros

  Si trabajamos con la opción de Guacamole nuestra máquina FlareVM no tendrá conexión a Internet, por lo que necesitaremos de un servidor SFTP para transferir ficheros. En el primer paso deberíamos haber descargado uno, la recomendación es utilizar un servidor simple como *Rebex Tiny SFTP Server*.{: style="text-align: justify;"}

  Si tenemos el ejecutable en nuestra máquina FlareVM, únicamente deberemos ejecutarlo y hacer clic en *Start* para tener el servidor funcionando.{: style="text-align: justify;"}

  [![](https://donttouchmynet.github.io/assets/images/rebexSFTP.PNG)](https://donttouchmynet.github.io/assets/images/rebexSFTP.PNG)

  Una vez esté funcionando, volvemos a las opciones de configuración de Guacamole, editamos la conexión y habilitamos el servicio SFTP{: style="text-align: justify;"}
  
  [![](https://donttouchmynet.github.io/assets/images/guacamoleconfigSFTP.PNG)](https://donttouchmynet.github.io/assets/images/guacamoleconfigSFTP.PNG)

  Lanzamos una nueva sesión y en esta ya nos permitirá copiar ficharos a la máquina, para esto simplemente hay que arrastras el fichero desde nuestra máquina al navegador. Los ficheros aparecerán en: *C:\Users\Administrator\Downloads\data*{: style="text-align: justify;"}

 ## Regenerar FlareVM

Tras detonar malware en nuestra máquina, si queremos volver a una máquina FlareVM en un estado limpio, con el siguiente comando de Terraform podremos eliminar la máquina FlareVM y generar una nueva:{: style="text-align: justify;"}
```terraform apply -replace=aws_instance.flarevm```

 **Importante** si estamos trabajando con el entorno con Guacamole, será necesario modificar la conexión y deshabilitar la opción de SFTP, de lo contrario no podremos conectar al no estar el SFTP habilitado. {: style="text-align: justify;"}

 ## Destruir el entorno
 Una vez hayamos finalizado de analizar malware, para ahorrar costes, procederemos a destruir el entorno. Para esto ejecutaremos el commando:{: style="text-align: justify;"}
 ```terraform destroy```

 Esto no eliminará nuestra AMI, así que cuando queramos volver a analizar malware simplemente necesitaremos volver a lanzar el comando terraform apply.{: style="text-align: justify;"}

 ## Costes aproximados
 Cuando el laboratorio está apagado, el único coste que pagaremos es el del [espacio ocupado por la AMI](https://aws.amazon.com/es/ebs/pricing/).
 Un disco de 60 GB tiene un precio aproximado de: 3 $ al mes.{: style="text-align: justify;"}

 Cuando el laboratorio esté encendido, pagaremos por las [instancias](https://aws.amazon.com/es/ec2/instance-types/t2/) y sus discos.{: style="text-align: justify;"}
 El entorno con Apache Guacamole tendrá un coste aproximado de: *0.12 $/H*{: style="text-align: justify;"}

 El entorno con sin Apache Guacamole tendrá un coste aproximado de: *0.17 $/H*{: style="text-align: justify;"}

